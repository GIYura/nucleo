# Анализ поведения memcpy() и структуры с __attribute__((packed)) на STM32

## Введение

Этот документ исследует, как влияет атрибут `__attribute__((packed))` и установка бита `UNALIGN_TRP` на корректность доступа к полям структуры в STM32 (на примере STM32F411), особенно при использовании `memcpy()` и других форм копирования.

## Структура данных

```c
typedef struct __attribute__((packed)) {
    uint8_t opCode;
    uint16_t param1;
    uint32_t param2;
} Packet_t;
```

или

```c
typedef struct {
    uint8_t opCode;
    uint16_t param1;
    uint32_t param2;
} Packet_t;
```

## Бит UNALIGN_TRP

**Регистр:** `SCB->CCR`  
**Бит:** `UNALIGN_TRP` (bit 3)  
**Значение:**
- `0`: Разрешены невыровненные доступы (по умолчанию на большинстве STM32)
- `1`: Невыровненные доступы (например, `LDRH`, `STR`) приводят к HardFault

## Тест кейсы

### Test Case 1: По байтовое копирование через `for`
**Условия:**
- `packed`
- `UNALIGN_TRP = 1`

✅ Работает. `dst[i] = m_buffer[i];` — всегда по байту

---

**Условия:**
- `not packed`
- `UNALIGN_TRP = 1`

❌ Поля `param1` и `param2` искажены — padding смещает смещения в памяти

---

### Test Case 2: `memcpy()` с локальными переменными

**Условия:**
- `packed`
- `UNALIGN_TRP = 1`

❌ `HardFault` — `memcpy()` может использовать `STRH`, `STR` → требует выровненных адресов

---

**Условия:**
- `not packed`
- `UNALIGN_TRP = 1`

✅ Работает — структура выровнена

---

### Test Case 3: Запись в поля напрямую

**Условия:**
- `packed`
- `UNALIGN_TRP = 1`

❌ `HardFault` — поле `param1` лежит на нечетном адресе

---

**Условия:**
- `not packed`
- `UNALIGN_TRP = 1`

✅ Работает — поля по выровненным адресам

---

### Test Case 4: `memcpy()` из `m_buffer` в поля структуры

**Условия:**
- `packed`
- `UNALIGN_TRP = 1`

❌ `HardFault` — `memcpy` может генерировать `LDRH`

---

**Условия:**
- `not packed`
- `UNALIGN_TRP = 1`

❌ `HardFault` — источник (`m_buffer[1]`) может быть не выровнен

## Общие выводы

- `packed` может привести к невыровненным полям → доступ к ним потенциально опасен
- `UNALIGN_TRP = 1` — строгий режим, полезен для диагностики, но может вызвать HardFault при обычных операциях
- `memcpy()` — может не быть безопасным даже при `-O0`
- Лучший способ при `packed` + `UNALIGN_TRP = 1` — по-байтовое копирование вручную

## Рекомендации

- Для передачи бинарных протоколов использовать `packed`, но аккуратно
- При чтении/записи в такие структуры:
  - либо использовать по байтные циклы
  - либо отключать `UNALIGN_TRP`, если уверены в поведении